<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <title>Logistic - Shipping Company Website Template</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Roboto:wght@500;700&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="/lib/animate/animate.min.css" rel="stylesheet">
    <link href="/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .logo{
            height: 100%;
            min-width: 200px;
        }
        .user-image {
            width: 22px; /* Adjust the width as needed */
            height: auto; /* Maintain aspect ratio */
            object-fit: cover; /* Ensure the image covers the entire space */
        }
        .card-header {
            background-color: #ff3e41;
            color: #fff;
            h5{
                color: white;
            }
        }
        .card-footer {
            background-color: #f8f9fa;
            border-top: none;
        }

    </style>
</head>

<body>
<!-- Spinner Start -->
<!--<div id="spinner" class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
    <div class="spinner-grow text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>-->
<!-- Spinner End -->


<!-- Navbar Start -->
<nav class="navbar navbar-expand-lg bg-white navbar-light shadow border-top border-5 border-primary sticky-top p-0">
    <a th:href="@{/index}" class="navbar-brand d-flex align-items-center">
        <img src="img/logo.png" alt="LMS" class="logo">
    </a>
    <button type="button" class="navbar-toggler me-4" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
        <div class="navbar-nav ms-auto p-4 p-lg-0">
            <a th:href="@{/index}" class="nav-item nav-link active">Home</a>
            <a th:href="@{/myBooking}" class="nav-item nav-link">My Booking</a>
            <a th:href="@{/about}" class="nav-item nav-link">About</a>
            <a th:href="@{/service}" class="nav-item nav-link">Services</a>
                <a class="nav-link nav-item dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <img src="/img/images.png" alt="User Image"  class="user-image">
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown" style="min-width: 200px;">
                    <li><a class="dropdown-item" th:href="@{/manageProfile}">Manage Profile</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" th:href="@{/logout}">Logout</a></li>
                </ul>
        </div>
        <!--<h4 class="m-0 pe-lg-5 d-none d-lg-block"><i class="fa fa-headphones text-primary me-3"></i>+012 345 6789</h4>-->
    </div>
</nav>
<!-- Navbar End -->
<div class="container mt-5" id="mainContainer">
    <div class="row justify-content-center">
        <!-- Manage Profile Card -->
        <div class="col-md-6">
            <div class="card mb-4 rounded-2 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 text-center">Manage Profile</h5>
                </div>
                <div class="card-body">
                    <form>
                        <div class="form-group">
                            <label for="firstName">First Name</label>
                            <input type="text" class="form-control" id="firstName" placeholder="Enter your first name">
                            <span class="text-danger" id="firstNameError"></span>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name</label>
                            <input type="text" class="form-control" id="lastName" placeholder="Enter your last name">
                            <span class="text-danger" id="lastNameError"></span>
                        </div>
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" class="form-control" id="email" value="example@example.com" readonly>
                        </div>
                        <div class="form-group">
                            <label for="mobileNumber">Mobile Number</label>
                            <input type="text" class="form-control" id="mobileNumber" placeholder="Enter your mobile number">
                            <span class="text-danger" id="mobileNumberError"></span>
                        </div>
                    </form>
                </div>
                <div class="card-footer d-flex justify-content-end">
                    <button onclick="onUpdateProfile()" type="button" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
        <!-- End Manage Profile Card -->

        <!-- Change Password Card -->
        <div class="col-md-6">
            <div class="card mb-4 rounded-2 shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 text-center">Change Password</h5>
                </div>
                <div class="card-body">
                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" placeholder="Enter current password" >
                            <span class="text-danger invalid-feedback" id="currentPasswordError"></span>

                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" class="form-control" id="newPassword" placeholder="Enter new password" >
                            <span class="text-danger invalid-feedback" id="newPasswordError"></span>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password" >
                            <span class="text-danger invalid-feedback" id="confirmPasswordError"></span>
                        </div>
                    </form>
                </div>
                <div class="card-footer d-flex justify-content-end">
                    <button onclick="updatePassword()" type="button" class="btn btn-primary">Change Password</button>
                </div>
            </div>
        </div>
        <!-- End Change Password Card -->
    </div>
</div>



<!-- Footer Start -->
<div class="container-fluid bg-dark text-light footer pt-5 wow fadeIn" data-wow-delay="0.1s" style="margin-top: 6rem;">

    <div class="container">
        <div class="copyright">
            <div class="row">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                    &copy; <a class="border-bottom" href="#">Logistic Management System</a>, All Right Reserved.
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <!--/*** This template is free as long as you keep the footer author’s credit link/attribution link/backlink. If you'd like to use the template without the footer author’s credit link/attribution link/backlink, you can purchase the Credit Removal License from "https://htmlcodex.com/credit-removal". Thank you for your support. ***/-->
                    Designed By <a class="border-bottom" href="https://htmlcodex.com">HTML Codex</a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Footer End -->

<!-- Back to Top -->
<a href="#" class="btn btn-lg btn-primary btn-lg-square rounded-0 back-to-top"><i class="bi bi-arrow-up"></i></a>


<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/lib/wow/wow.min.js"></script>
<script src="/lib/easing/easing.min.js"></script>
<script src="/lib/waypoints/waypoints.min.js"></script>
<script src="/lib/counterup/counterup.min.js"></script>
<script src="/lib/owlcarousel/owl.carousel.min.js"></script>
<script th:inline="javascript">
    let userDetails = {}
    $(document).ready(function (){
        fetchUserProfile();

        $('#firstName, #lastName, #mobileNumber').on('input', function() {
            validateForm(); // Validate form fields
        });
        $('#confirmPassword, #currentPassword, #newPassword').on('input', function() {
            console.log("Sss")
            validateChangePasswordForm();
        });
    })
    function fetchUserProfile() {
        $.ajax({
            url: '/me',
            type: 'GET',
            success: function(response) {
                userDetails = response;
                bindData(response)
            },
            error: function(xhr, status, error) {

            }
        });
    }

    function bindData(data){
        $('#firstName').val(data.firstName);
        $('#lastName').val(data.lastName);
        $('#email').val(data.email);
        $('#mobileNumber').val(data.mobileNo);
    }
    function validateForm() {
        clearErrors(); // Clear previous errors

        let firstName = $('#firstName').val().trim();
        let lastName = $('#lastName').val().trim();
        let mobileNumber = $('#mobileNumber').val().trim();

        let isValid = true; // Flag to track overall form validity

        // Validate first name
        if (firstName === '') {
            $('#firstNameError').text('First name cannot be blank');
            isValid = false;
        } else if (!isValidName(firstName)) {
            $('#firstNameError').text('Please enter a valid first name');
            isValid = false;
        }

        // Validate last name
        if (lastName === '') {
            $('#lastNameError').text('Last name cannot be blank');
            isValid = false;
        } else if (!isValidName(lastName)) {
            $('#lastNameError').text('Please enter a valid last name');
            isValid = false;
        }

        // Validate mobile number
        if (mobileNumber === '') {
            $('#mobileNumberError').text('Mobile number cannot be blank');
            isValid = false;
        } else if (!isValidMobileNumber(mobileNumber)) {
            $('#mobileNumberError').text('Please enter a valid 10-digit mobile number');
            isValid = false;
        }

        return isValid; // Return form validity status
    }

    // Function to clear previous errors
    function clearErrors() {
        $('.text-danger').text(''); // Clear all error messages
    }

    // Function to validate first and last name
    function isValidName(name) {
        return /^[a-zA-Z\s]+$/.test(name);
    }

    // Function to validate mobile number
    function isValidMobileNumber(mobileNumber) {
        return /^\d{10}$/.test(mobileNumber);
    }


    function onUpdateProfile(){
        if(validateForm()){
            let firstName = $('#firstName').val().trim();
            let lastName = $('#lastName').val().trim();
            let mobileNumber = $('#mobileNumber').val().trim();

            $.ajax({
                type: 'PUT',
                url: '/updateProfile',
                contentType: 'application/json',
                data: JSON.stringify({
                    ...userDetails,
                    firstName:firstName,
                    lastName: lastName,
                    mobileNo: mobileNumber,
                }),
                success: function(response) {
                    userDetails = response;
                    displayAlert("Profile Updated Successfully!", "success")
                    bindData(response)
                },
                error: function(xhr, status, error) {
                    // Handle error response
                    console.error('Error updating profile:', error);
                }
            });
        }
    }
    function displayAlert(message, alertType) {
        var alertElement = document.createElement('div');
        alertElement.classList.add('alert', 'alert-' + alertType);
        alertElement.setAttribute('role', 'alert');
        alertElement.innerHTML = message;

        document.getElementById("mainContainer").before(alertElement);
        setTimeout(function() {
            alertElement.remove();
        }, 3000);
    }

    function validateChangePasswordForm() {
        var currentPassword = $("#currentPassword").val().trim();
        var newPassword = $("#newPassword").val().trim();
        var confirmPassword = $("#confirmPassword").val().trim();

        $(".invalid-feedback").text(""); // Clear previous error messages

        var hasError = false;

        if (currentPassword === "") {
            $("#currentPasswordError").text("Please enter current password.");
            $("#currentPasswordError").css("display", "block");
            hasError = true;
        }
        if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(newPassword)) {
            $("#newPasswordError").text("Password must be a minimum of eight characters long and include at least one uppercase letter, one lowercase letter, one number, and one special character. Special characters allowed are @$!%*?&");
            $("#newPasswordError").css("display", "block");
            hasError = true;
        }
        if (newPassword === "") {
            $("#newPasswordError").text("Please enter new password.");
            $("#newPasswordError").css("display", "block");
            hasError = true;
        }
        if (confirmPassword === "") {
            $("#confirmPasswordError").text("Please confirm new password.");
            $("#confirmPasswordError").css("display", "block");
            hasError = true;
        }
        if (newPassword !== confirmPassword) {
            $("#confirmPasswordError").text("Passwords do not match.");
            $("#confirmPasswordError").css("display", "block");
            hasError = true;
        }
        return hasError;
    }

    function updatePassword(){
        if(!validateChangePasswordForm()){
            console.log("ddd")
            let currentPassword = $("#currentPassword").val().trim();
            let newPassword = $("#newPassword").val().trim();
            let confirmPassword = $("#confirmPassword").val().trim();
            $.ajax({
                type: 'PUT',
                url: '/changePassword',
                contentType: 'application/json',
                data: JSON.stringify({
                    confirmPassword: confirmPassword ,
                    newPassword:newPassword,
                    oldPassword:currentPassword
                }),
                success: function(response) {
                    if(response && response.isError){
                        if(response.isOldError){
                            $("#currentPasswordError").text(response.errorMessage);
                            $("#currentPasswordError").css("display", "block");
                        }else{
                            $("#newPasswordError").text(response.errorMessage);
                            $("#newPasswordError").css("display", "block");
                        }

                    }else{
                         $("#currentPassword").val("");
                        $("#newPassword").val("")
                        $("#confirmPassword").val("")
                        displayAlert("Password Changed Successfully!","success")
                    }
                },
                error: function(xhr, status, error) {
                    // Handle error response
                    console.error('Error updating profile:', error);
                }
            });
        }
    }
</script>
</body>

</html>